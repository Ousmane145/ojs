name: CD - DÃ©ploiement vers Serveur OJS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement de dÃ©ploiement'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      ojs-version:
        description: 'Version OJS cible'
        required: true
        default: '3.4'
        type: choice
        options:
        - '3.5'
        - '3.4'

jobs:
  deploy:
    name: DÃ©ployer sur Serveur OJS
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Ajouter le serveur Ã  known_hosts
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H $SERVER_IP >> ~/.ssh/known_hosts

    - name: Valider la connexion SSH
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
      run: |
        echo "ðŸ”— Test de connexion au serveur..."
        ssh -o BatchMode=yes $SERVER_USER@$SERVER_IP "echo 'Connexion SSH rÃ©ussie!'"

    - name: CrÃ©er une archive du plugin
      run: |
        echo "ðŸ“¦ CrÃ©ation de l'archive..."
        cd plugins/generic/santaneAnalysisPlugin/
        tar -czf santane-analysis-plugin.tar.gz ./*
        ls -la santane-analysis-plugin.tar.gz

    - name: DÃ©ployer sur le serveur OJS
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
      run: |
        echo "ðŸš€ DÃ©ploiement en cours..."
        
        # Copier l'archive
        scp plugins/generic/santaneAnalysisPlugin/santane-analysis-plugin.tar.gz \
          $SERVER_USER@$SERVER_IP:/tmp/
        
        # Commande de dÃ©ploiement distant
        ssh $SERVER_USER@$SERVER_IP << 'EOF'
          set -e
          echo "ðŸ“ DÃ©ploiement sur le serveur..."
          
          OJS_DIR="/var/www/html/ojs"
          PLUGIN_DIR="$OJS_DIR/plugins/generic/santaneAnalysisPlugin"
          BACKUP_DIR="/tmp/plugin-backups"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)

          mkdir -p $BACKUP_DIR

          if [ -d "$PLUGIN_DIR" ]; then
            echo "ðŸ’¾ Sauvegarde de l'ancienne version..."
            tar -czf "$BACKUP_DIR/santane-analysis-backup-$TIMESTAMP.tar.gz" -C $PLUGIN_DIR .
          fi

          sudo mkdir -p $PLUGIN_DIR
          sudo chown $USER:www-data $PLUGIN_DIR
          sudo chmod 755 $PLUGIN_DIR

          echo "ðŸ“‚ Extraction de la nouvelle version..."
          tar -xzf /tmp/santane-analysis-plugin.tar.gz -C $PLUGIN_DIR

          sudo chown -R $USER:www-data $PLUGIN_DIR
          sudo find $PLUGIN_DIR -type d -exec chmod 755 {} \;
          sudo find $PLUGIN_DIR -type f -exec chmod 644 {} \;

          rm /tmp/santane-analysis-plugin.tar.gz
          echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s!"
          echo "ðŸ“‹ RÃ©sumÃ©:"
          echo "   - Backup: $BACKUP_DIR/santane-analysis-backup-$TIMESTAMP.tar.gz"
          echo "   - Nouvelle version dÃ©ployÃ©e dans: $PLUGIN_DIR"
          echo "   - Nombre de fichiers: $(find $PLUGIN_DIR -type f | wc -l)"
        EOF

    - name: VÃ©rifier le dÃ©ploiement
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
      run: |
        echo "ðŸ” VÃ©rification du dÃ©ploiement..."
        ssh $SERVER_USER@$SERVER_IP "
          PLUGIN_DIR=\"/var/www/html/ojs/plugins/generic/santaneAnalysisPlugin\"
          if [ -d \"\$PLUGIN_DIR\" ]; then
            echo 'âœ… Plugin dÃ©ployÃ© avec succÃ¨s'
            echo 'ðŸ“ Structure:'
            find \$PLUGIN_DIR -name '*.php' -o -name '*.js' -o -name '*.css' -o -name '*.xml' | head -10
            echo 'ðŸ“Š Taille:'
            du -sh \$PLUGIN_DIR
          else
            echo 'âŒ Erreur: Plugin non trouvÃ©'
            exit 1
          fi
        "

    - name: Notifier le succÃ¨s
      if: success()
      run: |
        echo "ðŸŽ‰ DÃ©ploiement rÃ©ussi vers ${{ github.event.inputs.environment }}!"
        echo "Version: ${{ github.event.inputs['ojs-version'] || 'latest' }}"

    - name: Notifier l'Ã©chec
      if: failure()
      run: |
        echo "âŒ Ã‰chec du dÃ©ploiement!"
        exit 1