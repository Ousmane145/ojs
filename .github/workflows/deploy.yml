# .github/workflows/deploy.yml
name: Deploy to Production

on:
  workflow_dispatch:  # Permet de dÃ©clencher manuellement

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install SSH key
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
        
    - - name: Deploy with Rsync
    env:
      SERVER_IP: ${{ secrets.SERVER_IP }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      DEPLOY_PATH: /var/www/html/ojs/plugins/generic/premiumSubmissionHelper
    run: |
      echo "ðŸš€ Starting deployment to $SERVER_IP:$DEPLOY_PATH"
    
      rsync -avz \
      --no-times \
      --omit-dir-times \
      --delete \
      --exclude='.git/' \
      --exclude='node_modules/' \
      --exclude='.env' \
      --exclude='*.log' \
      -e "ssh -o StrictHostKeyChecking=no" \
      ./ \
      $SERVER_USER@$SERVER_IP:$DEPLOY_PATH/
    
      echo "ðŸ“‹ Verifying deployment..."
      ssh $SERVER_USER@$SERVER_IP "ls -la $DEPLOY_PATH/ && echo 'âœ… Deployment verified!'"
    
      echo "ðŸŽ‰ Deployment completed successfully!"