name: ðŸš€ DÃ©ploiement sur Serveur OJS

on:
  workflow_run:
    workflows: ["CI - Lint et Validation PHP"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH without passphrase prompt
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

    - name: Test SSH connection
      run: |
        echo "Testing SSH connection..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "echo 'SSH connection successful!'"

    - name: Create plugin archive
      run: |
        echo "Creating deployment archive..."
        tar -czf santane-plugin.tar.gz -C plugins/generic/santaneAnalysisPlugin/ .

    - name: Deploy to OJS server
      run: |
        echo "Deploying plugin..."
        scp santane-plugin.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
          cd /tmp &&
          tar -xzf santane-plugin.tar.gz -C ${{ secrets.DEPLOY_PATH }}/plugins/generic/santaneAnalysisPlugin/ &&
          chmod -R 755 ${{ secrets.DEPLOY_PATH }}/plugins/generic/santaneAnalysisPlugin/ &&
          rm santane-plugin.tar.gz
        "

    - name: Verify deployment
      run: |
        echo "Verifying deployment..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
          ls -la ${{ secrets.DEPLOY_PATH }}/plugins/generic/santaneAnalysisPlugin//
          echo 'Deployment verified successfully!'
        "

    - name: Notify success
      run: echo "âœ… DÃ©ploiement rÃ©ussi!"